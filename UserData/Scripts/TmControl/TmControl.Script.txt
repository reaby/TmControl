#RequireContext CServerPlugin

#Include "TMControl/Core/config.Script.txt" as Config
#Include "TMControl/Core/pluginManager.Script.txt" as PluginManager
#Include "TMControl/Core/serverManager.Script.txt" as Server

main() {
    declare Boolean isStartDone = False;
    Config::Init();
    PluginManager::Init();
    
    while (True) {   
        yield;   
        
        foreach (Event in PendingEvents) {            
            declare TempEvent <=> Event;
            
            if (isStartDone == False && Event.Type == CServerPluginEvent::EType::MapLoaded) {
                isStartDone = True;
                Server::onModeReady();
            }

            PluginManager::HandleEvent(TempEvent);
        }
        
        foreach (UIEvent in UIManager.PendingEvents) {            
            declare TempUiEvent <=> UIEvent;
            PluginManager::HandleUiEvent(TempUiEvent);
        }
        
        foreach (XPEvent in XmlRpc.PendingEvents) {
           // log(XPEvent);
        }
        
        Server::ProcessActions();    
    }
}
